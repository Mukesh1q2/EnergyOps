# Logstash Configuration for OptiBid Energy Platform
# Processes logs from Filebeat and sends to Elasticsearch

input {
  beats {
    port => 5000
    codec => json
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "parsed"
    }
    
    # Move parsed fields to root
    ruby {
      code => "
        parsed = event.get('parsed')
        if parsed.is_a?(Hash)
          parsed.each { |k, v| event.set(k, v) }
          event.remove('parsed')
        end
      "
    }
  }
  
  # Add timestamp
  if [asctime] {
    date {
      match => [ "asctime", "ISO8601", "yyyy-MM-dd HH:mm:ss" ]
      target => "@timestamp"
    }
  }
  
  # Normalize log level
  if [levelname] {
    mutate {
      rename => { "levelname" => "log_level" }
      uppercase => [ "log_level" ]
    }
  } else if [level] {
    mutate {
      rename => { "level" => "log_level" }
      uppercase => [ "log_level" ]
    }
  }
  
  # Add tags based on log type
  if [log_type] == "security" {
    mutate {
      add_tag => [ "security" ]
    }
  }
  
  if [log_type] == "error" or [log_level] == "ERROR" or [log_level] == "CRITICAL" {
    mutate {
      add_tag => [ "error" ]
    }
  }
  
  if [log_type] == "access" {
    mutate {
      add_tag => [ "access" ]
    }
  }
  
  # Extract event type
  if [event_type] {
    mutate {
      add_tag => [ "%{event_type}" ]
    }
  }
  
  # Parse user agent
  if [user_agent] {
    useragent {
      source => "user_agent"
      target => "ua"
    }
  }
  
  # GeoIP lookup for IP addresses
  if [ip_address] {
    geoip {
      source => "ip_address"
      target => "geoip"
    }
  }
  
  # Add environment tag
  if [environment] {
    mutate {
      add_tag => [ "env:%{environment}" ]
    }
  }
  
  # Parse duration fields
  if [duration_ms] {
    mutate {
      convert => { "duration_ms" => "float" }
    }
  }
  
  # Parse status code
  if [status_code] {
    mutate {
      convert => { "status_code" => "integer" }
    }
  }
  
  # Add severity score
  if [log_level] == "CRITICAL" {
    mutate {
      add_field => { "severity_score" => 5 }
    }
  } else if [log_level] == "ERROR" {
    mutate {
      add_field => { "severity_score" => 4 }
    }
  } else if [log_level] == "WARNING" {
    mutate {
      add_field => { "severity_score" => 3 }
    }
  } else if [log_level] == "INFO" {
    mutate {
      add_field => { "severity_score" => 2 }
    }
  } else {
    mutate {
      add_field => { "severity_score" => 1 }
    }
  }
  
  # Remove unnecessary fields
  mutate {
    remove_field => [ "agent", "ecs", "input", "log", "host" ]
  }
}

output {
  # Main logs index
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "optibid-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }
  
  # Error logs to separate index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "optibid-errors-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # Security logs to separate index
  if "security" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "optibid-security-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # Access logs to separate index
  if "access" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "optibid-access-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # Debug output (comment out in production)
  # stdout {
  #   codec => rubydebug
  # }
}
