# OptiBid Energy: Kubernetes Security Configuration
# Service Accounts, RBAC, and Secrets Management

---
# OptiBid Backend Service Account with IAM Role
apiVersion: v1
kind: ServiceAccount
metadata:
  name: optibid-backend
  namespace: optibid
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/optibid-backend-role
    eks.amazonaws.com/sts-regional-endpoints: "true"

---
# OptiBid Frontend Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: optibid-frontend
  namespace: optibid

---
# Prometheus Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: kube-prometheus

---
# Grafana Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grafana
  namespace: kube-prometheus

---
# RBAC: OptiBid Backend ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: optibid-backend
rules:
- apiGroups: [""]
  resources: ["secrets", "configmaps"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["metrics.k8s.io"]
  resources: ["pods", "nodes"]
  verbs: ["get", "list"]

---
# RBAC: OptiBid Backend ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: optibid-backend
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: optibid-backend
subjects:
- kind: ServiceAccount
  name: optibid-backend
  namespace: optibid

---
# RBAC: Prometheus ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus
rules:
- apiGroups: [""]
  resources: ["nodes", "nodes/proxy", "services", "endpoints", "pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["extensions"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]
- nonResourceURLs: ["/metrics"]
  verbs: ["get"]

---
# RBAC: Prometheus ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus
subjects:
- kind: ServiceAccount
  name: prometheus
  namespace: kube-prometheus

---
# Network Policy: OptiBid Namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: optibid-default-deny-all
  namespace: optibid
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# Network Policy: Allow DNS
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: optibid-allow-dns
  namespace: optibid
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Network Policy: Allow API Server
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: optibid-allow-api-server
  namespace: optibid
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: default
    ports:
    - protocol: TCP
      port: 443

---
# Network Policy: Allow OptiBid Services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: optibid-allow-services
  namespace: optibid
spec:
  podSelector:
    matchLabels:
      app: optibid
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: optibid
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 8000
    - protocol: TCP
      port: 3000
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-prometheus
    ports:
    - protocol: TCP
      port: 8000
    - protocol: TCP
      port: 3000
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443

---
# Network Policy: Allow Database
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: optibid-allow-database
  namespace: optibid
spec:
  podSelector:
    matchLabels:
      app: postgresql
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: optibid
    - podSelector:
        matchLabels:
          app: optibid-backend
    ports:
    - protocol: TCP
      port: 5432

---
# Network Policy: Allow Redis
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: optibid-allow-redis
  namespace: optibid
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: optibid
    - podSelector:
        matchLabels:
          app: optibid-backend
    ports:
    - protocol: TCP
      port: 6379

---
# Pod Security Policy
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: optibid-psp
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: 'runtime/default'
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'persistentVolumeClaim'
  hostNetwork: false
  hostIPC: false
  hostPID: false
  runAsUser:
    rule: 'MustRunAsNonRoot'
  supplementalGroups:
    rule: 'MustRunAs'
    ranges:
      - min: 1
        max: 65535
  fsGroup:
    rule: 'MustRunAs'
    ranges:
      - min: 1
        max: 65535
  readOnlyRootFilesystem: false

---
# RBAC: Pod Security Policy
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: optibid-psp
rules:
- apiGroups: ['policy']
  resources: ['podsecuritypolicies']
  verbs: ['use']
  resourceNames:
    - optibid-psp

---
# RBAC: Pod Security Policy Binding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: optibid-psp
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: optibid-psp
subjects:
- kind: ServiceAccount
  name: optibid-backend
  namespace: optibid
- kind: ServiceAccount
  name: optibid-frontend
  namespace: optibid
- kind: ServiceAccount
  name: prometheus
  namespace: kube-prometheus

---
# Security Context Constraints (for OpenShift compatibility)
apiVersion: security.openshift.io/v1
kind: SecurityContextConstraints
metadata:
  name: optibid-scc
priority: 10
allowPrivilegedContainer: false
allowedCapabilities: []
defaultAddCapabilities: []
requiredDropCapabilities:
- MKNOD
- SYS_ADMIN
- NET_ADMIN
- ALL
volumes:
- configMap
- emptyDir
- projected
- secret
- persistentVolumeClaim
seccompProfile:
  type: RuntimeDefault
runAsUser:
  type: MustRunAsNonRoot
supplementalGroups:
  type: MustRunAs
  ranges:
  - min: 1
    max: 65535
fsGroup:
  type: MustRunAs
  ranges:
  - min: 1
    max: 65535
readOnlyRootFilesystem: false