# OptiBid Energy: Helm Chart for Application Deployment
# Production-ready Helm chart with values and templates

# Chart.yaml
apiVersion: v2
name: optibid
description: OptiBid Energy Platform - Production Kubernetes Deployment
type: application
version: 1.0.0
appVersion: "1.0.0"
keywords:
  - energy
  - optimization
  - trading
  - analytics
home: https://optibid.com
sources:
  - https://github.com/optibid/energy-platform
maintainers:
  - name: OptiBid Team
    email: devops@optibid.com

---
# values.yaml
global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: "gp3"

image:
  backend:
    repository: optibid/backend
    tag: "latest"
    pullPolicy: IfNotPresent
  frontend:
    repository: optibid/frontend
    tag: "latest"
    pullPolicy: IfNotPresent
  postgresql:
    repository: timescale/timescaledb
    tag: "latest-pg14"
    pullPolicy: IfNotPresent
  redis:
    repository: redis
    tag: "7-alpine"
    pullPolicy: IfNotPresent

replicaCount:
  backend: 3
  frontend: 3

resources:
  backend:
    limits:
      cpu: 2
      memory: 4Gi
    requests:
      cpu: 500m
      memory: 1Gi
  frontend:
    limits:
      cpu: 1
      memory: 2Gi
    requests:
      cpu: 250m
      memory: 512Mi
  postgresql:
    limits:
      cpu: 4
      memory: 8Gi
    requests:
      cpu: 1000m
      memory: 2Gi
  redis:
    limits:
      cpu: 1
      memory: 2Gi
    requests:
      cpu: 250m
      memory: 1Gi

autoscaling:
  enabled: true
  backend:
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  frontend:
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  hosts:
    - host: optibid.com
      paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: frontend
              port:
                number: 3000
  tls:
    - secretName: optibid-tls
      hosts:
        - optibid.com

postgresql:
  enabled: true
  auth:
    postgresPassword: "CHANGE_ME"
    username: "optibid_admin"
    password: "CHANGE_ME"
    database: "optibid"
  primary:
    persistence:
      enabled: true
      size: 100Gi
      storageClass: "gp3"
  secondary:
    enabled: true
    persistence:
      enabled: true
      size: 100Gi
      storageClass: "gp3"

redis:
  enabled: true
  auth:
    enabled: true
    password: "CHANGE_ME"
  master:
    persistence:
      enabled: true
      size: 20Gi
      storageClass: "gp3"
  replica:
    replicaCount: 2
    persistence:
      enabled: true
      size: 20Gi
      storageClass: "gp3"

monitoring:
  enabled: true
  prometheus:
    enabled: true
    replicaCount: 1
    storageSize: 10Gi
  grafana:
    enabled: true
    adminPassword: "CHANGE_ME"
    persistence:
      enabled: true
      size: 5Gi
      storageClass: "gp3"
  alertmanager:
    enabled: true

securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

# Environment-specific overrides
environments:
  development:
    replicaCount:
      backend: 1
      frontend: 1
    ingress:
      enabled: false
    monitoring:
      enabled: false
  
  staging:
    replicaCount:
      backend: 2
      frontend: 2
    monitoring:
      enabled: true
  
  production:
    replicaCount:
      backend: 3
      frontend: 3
    monitoring:
      enabled: true

---
# templates/_helpers.tpl
{{/*
Expand the name of the chart.
*/}}
{{- define "optibid.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a default fully qualified app name.
*/}}
{{- define "optibid.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- $name := default .Chart.Name .Values.nameOverride }}
{{- if contains $name .Release.Name }}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
{{- end }}

{{/*
Create chart name and version as used by the chart label.
*/}}
{{- define "optibid.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Common labels
*/}}
{{- define "optibid.labels" -}}
helm.sh/chart: {{ include "optibid.chart" . }}
{{ include "optibid.selectorLabels" . }}
{{- if .Chart.AppVersion }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
{{- end }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{/*
Selector labels
*/}}
{{- define "optibid.selectorLabels" -}}
app.kubernetes.io/name: {{ include "optibid.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{/*
Create the name of the service account to use
*/}}
{{- define "optibid.serviceAccountName" -}}
{{- if .Values.serviceAccount.create }}
{{- default (include "optibid.fullname" .) .Values.serviceAccount.name }}
{{- else }}
{{- default "default" .Values.serviceAccount.name }}
{{- end }}
{{- end }}

---
# templates/backend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "optibid.fullname" . }}-backend
  labels:
    {{- include "optibid.labels" . | nindent 4 }}
    component: backend
spec:
  replicas: {{ .Values.replicaCount.backend }}
  selector:
    matchLabels:
      {{- include "optibid.selectorLabels" . | nindent 6 }}
      component: backend
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        prometheus.io/path: "/metrics"
      labels:
        {{- include "optibid.selectorLabels" . | nindent 8 }}
        component: backend
    spec:
      serviceAccountName: {{ include "optibid.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.securityContext | nindent 8 }}
      containers:
      - name: backend
        image: "{{ .Values.image.backend.repository }}:{{ .Values.image.backend.tag }}"
        imagePullPolicy: {{ .Values.image.backend.pullPolicy }}
        ports:
        - name: http
          containerPort: 8000
          protocol: TCP
        - name: health
          containerPort: 8001
          protocol: TCP
        env:
        - name: ENVIRONMENT
          value: {{ .Values.environment | default "production" | quote }}
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: {{ include "optibid.fullname" . }}-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: {{ include "optibid.fullname" . }}-secrets
              key: redis-url
        resources:
          {{- toYaml .Values.resources.backend | nindent 10 }}
        livenessProbe:
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: health
          initialDelaySeconds: 5
          periodSeconds: 5

---
# templates/frontend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "optibid.fullname" . }}-frontend
  labels:
    {{- include "optibid.labels" . | nindent 4 }}
    component: frontend
spec:
  replicas: {{ .Values.replicaCount.frontend }}
  selector:
    matchLabels:
      {{- include "optibid.selectorLabels" . | nindent 6 }}
      component: frontend
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
      labels:
        {{- include "optibid.selectorLabels" . | nindent 8 }}
        component: frontend
    spec:
      serviceAccountName: {{ include "optibid.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.securityContext | nindent 8 }}
      containers:
      - name: frontend
        image: "{{ .Values.image.frontend.repository }}:{{ .Values.image.frontend.tag }}"
        imagePullPolicy: {{ .Values.image.frontend.pullPolicy }}
        ports:
        - name: http
          containerPort: 3000
          protocol: TCP
        env:
        - name: NODE_ENV
          value: {{ .Values.environment | default "production" | quote }}
        - name: NEXT_PUBLIC_API_URL
          value: "https://api.optibid.com"
        resources:
          {{- toYaml .Values.resources.frontend | nindent 10 }}
        livenessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/health
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5

---
# templates/backend-hpa.yaml
{{- if .Values.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "optibid.fullname" . }}-backend-hpa
  labels:
    {{- include "optibid.labels" . | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "optibid.fullname" . }}-backend
  minReplicas: {{ .Values.autoscaling.backend.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.backend.maxReplicas }}
  metrics:
  {{- if .Values.autoscaling.backend.targetCPUUtilizationPercentage }}
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.backend.targetCPUUtilizationPercentage }}
  {{- end }}
  {{- if .Values.autoscaling.backend.targetMemoryUtilizationPercentage }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.backend.targetMemoryUtilizationPercentage }}
  {{- end }}
{{- end }}

---
# templates/frontend-hpa.yaml
{{- if .Values.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "optibid.fullname" . }}-frontend-hpa
  labels:
    {{- include "optibid.labels" . | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "optibid.fullname" . }}-frontend
  minReplicas: {{ .Values.autoscaling.frontend.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.frontend.maxReplicas }}
  metrics:
  {{- if .Values.autoscaling.frontend.targetCPUUtilizationPercentage }}
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.frontend.targetCPUUtilizationPercentage }}
  {{- end }}
  {{- if .Values.autoscaling.frontend.targetMemoryUtilizationPercentage }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.frontend.targetMemoryUtilizationPercentage }}
  {{- end }}
{{- end }}

---
# templates/ingress.yaml
{{- if .Values.ingress.enabled -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "optibid.fullname" . }}
  labels:
    {{- include "optibid.labels" . | nindent 4 }}
  {{- with .Values.ingress.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  {{- if .Values.ingress.tls }}
  tls:
    {{- range .Values.ingress.tls }}
    - hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .secretName }}
    {{- end }}
  {{- end }}
  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
          {{- range .paths }}
          - path: {{ .path }}
            pathType: {{ .pathType }}
            backend:
              service:
                name: {{ .backend.service.name }}
                port:
                  number: {{ .backend.service.port.number }}
          {{- end }}
    {{- end }}
{{- end }}

---
# templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "optibid.fullname" . }}-secrets
  labels:
    {{- include "optibid.labels" . | nindent 4 }}
type: Opaque
stringData:
  database-url: "postgresql://{{ .Values.postgresql.auth.username }}:{{ .Values.postgresql.auth.password }}@postgresql:5432/{{ .Values.postgresql.auth.database }}"
  redis-url: "redis://:{{ .Values.redis.auth.password }}@redis:6379/0"
  postgres-password: {{ .Values.postgresql.auth.postgresPassword | quote }}
  redis-password: {{ .Values.redis.auth.password | quote }}
  secret-key: "CHANGE_ME_SECRET_KEY"
  jwt-secret-key: "CHANGE_ME_JWT_SECRET_KEY"

---
# templates/_tpl.tpl
{{/* Validate required values */}}
{{- define "optibid.validateValues" -}}
{{- if not .Values.postgresql.auth.password -}}
{{- fail "postgresql.auth.password is required" -}}
{{- end -}}
{{- if not .Values.redis.auth.password -}}
{{- fail "redis.auth.password is required" -}}
{{- end -}}
{{- end -}}

{{/* Render environment-specific configuration */}}
{{- define "optibid.environment" -}}
{{- $env := .Values.environment | default "production" -}}
{{- index $.Values.environments $env | default $.Values -}}
{{- end -}}

---
# templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "optibid.fullname" . }}-test-connection"
  labels:
    {{- include "optibid.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
  - name: wget
    image: busybox
    command: ['wget']
    args: ['{{ include "optibid.fullname" . }}-backend:8000/health']
  restartPolicy: Never