name: Build & Deploy (Docker Compose â†’ VPS)

# Give Actions permission to push container packages
permissions:
  contents: read
  packages: write

on:
  push:
    branches:
      - main

jobs:
  build_and_push:
    name: Build and push images to GHCR
    runs-on: ubuntu-latest
    outputs:
      frontend_image: ${{ steps.frontend.outputs.image }}
      backend_image: ${{ steps.backend.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (optional cross-build)
        uses: docker/setup-qemu-action@v2

      - name: Lowercase Repository Owner
        id: owner
        run: |
          echo "owner=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build and push frontend image
        id: frontend
        uses: docker/build-push-action@v4
        with:
          context: ./enterprise-marketing
          file: ./enterprise-marketing/Dockerfile
          push: true
          tags: ghcr.io/${{ steps.owner.outputs.owner }}/energyops-frontend:${{ github.sha }},ghcr.io/${{ steps.owner.outputs.owner }}/energyops-frontend:latest
      - name: Set frontend output
        run: echo "image=ghcr.io/${{ steps.owner.outputs.owner }}/energyops-frontend:${{ github.sha }}" >> $GITHUB_OUTPUT
        id: set-frontend

      - name: Build and push backend image
        id: backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ghcr.io/${{ steps.owner.outputs.owner }}/energyops-backend:${{ github.sha }},ghcr.io/${{ steps.owner.outputs.owner }}/energyops-backend:latest
      - name: Set backend output
        run: echo "image=ghcr.io/${{ steps.owner.outputs.owner }}/energyops-backend:${{ github.sha }}" >> $GITHUB_OUTPUT
        id: set-backend

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: Checkout (for compose file)
        uses: actions/checkout@v4

      - name: Lowercase Repository Owner
        id: owner
        run: |
          echo "owner=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -H "${{ secrets.SERVER_HOST }}" >> ~/.ssh/known_hosts
          fi

      - name: Create .env file with GHCR_NAMESPACE
        run: |
          echo "GHCR_NAMESPACE=${{ steps.owner.outputs.owner }}" > .env.generated

      - name: Rsync docker-compose, env, and helper scripts to server
        run: |
          # Sync docker-compose.prod.yml
          rsync -avz -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes" ./docker-compose.prod.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/docker-compose.prod.yml

          # Sync generated .env file
          rsync -avz -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes" ./.env.generated ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/.env.ghcr

          # Sync deploy folder (scripts, systemd service)
          rsync -avz -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes" -r ./deploy ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/

          # Sync .env.production if it exists
          if [ -f ./.env.production ]; then
            rsync -avz -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes" ./.env.production ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/.env
          fi

      - name: Trigger remote docker-compose pull & up
        env:
          GHCR_USER: ${{ steps.owner.outputs.owner }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "GHCR_USER=$GHCR_USER GHCR_PAT=$GHCR_PAT DEPLOY_PATH=$DEPLOY_PATH /bin/bash -s" <<'REMOTE'
            set -euo pipefail
            cd "${DEPLOY_PATH:-${HOME}}"

            # Make sure the deploy scripts are executable
            if [ -d "deploy" ]; then
              chmod +x deploy/*.sh 2>/dev/null || true
            fi

            # Load GHCR namespace from the transferred file
            if [ -f .env.ghcr ]; then
              export $(grep -v '^#' .env.ghcr | xargs)
            fi

            export GHCR_NAMESPACE="$GHCR_USER"

            # Login to GHCR so server can pull private images
            echo "$GHCR_PAT" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            # Ensure compose file exists
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            docker image prune -f
          REMOTE
